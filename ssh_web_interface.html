<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Parameter Manager - VSCode Edition</title>
    
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <!-- YAML Parser for validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        .status-info {
            display: flex;
            gap: 30px;
        }

        .status-item {
            text-align: center;
        }

        .status-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .status-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        /* Monaco Editor Section */
        .editor-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .editor-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .editor-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .editor-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .editor-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .editor-tab:hover {
            color: #2c3e50;
            background: rgba(0, 0, 0, 0.05);
        }

        .editor-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
            position: relative;
            background: #1e1e1e;
        }

        .editor-toolbar {
            background: #2d2d30;
            color: #cccccc;
            padding: 8px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .editor-toolbar-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .editor-toolbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .toolbar-btn {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #464647;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: #094771;
            border-color: #007acc;
        }

        .toolbar-btn.active {
            background: #007acc;
            color: white;
            border-color: #007acc;
        }

        .editor-status {
            color: #cccccc;
            font-size: 11px;
        }

        #monaco-editor {
            height: 450px;
        }

        .preview-container {
            height: 450px;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            display: none;
        }

        .diff-container {
            height: 450px;
            display: none;
        }

        /* Customer Management */
        .customers-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .customer-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }

        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .customer-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .customer-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .customer-server {
            font-size: 12px;
            color: #6c757d;
        }

        .customer-actions {
            display: flex;
            gap: 5px;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .bulk-form {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 15px;
            align-items: end;
        }

        .bulk-form > div {
            display: flex;
            flex-direction: column;
        }

        .bulk-form label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .bulk-form input, .bulk-form select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .selected-count {
            background: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .customers-section {
                grid-template-columns: 1fr;
            }
            
            .bulk-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 10px;
            }
            
            .main-content {
                padding: 20px;
            }

            .status-info {
                gap: 15px;
            }

            .editor-container {
                height: 350px;
            }

            #monaco-editor {
                height: 300px;
            }

            .preview-container, .diff-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 SSH Parameter Manager</h1>
            <p>VSCode-Edition mit professionellem YAML-Editor</p>
        </div>

        <div class="main-content">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-info">
                    <div class="status-item">
                        <div class="status-value" id="total-customers">-</div>
                        <div class="status-label">Kunden</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="connected-servers">-</div>
                        <div class="status-label">Server verbunden</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="selected-customers">0</div>
                        <div class="status-label">Ausgewählt</div>
                    </div>
                </div>
                <button class="refresh-btn" onclick="loadSystemStatus()">🔄 Status aktualisieren</button>
            </div>

            <!-- Status Messages -->
            <div id="status-message" class="status-message"></div>

            <!-- Monaco Editor Section -->
            <div class="editor-section">
                <div class="editor-header">
                    <div class="editor-title">
                        💻 VSCode YAML Editor
                        <span class="editor-status" id="editor-status">Bereit</span>
                    </div>
                    <div class="editor-controls">
                        <select id="customer-selector" onchange="loadCustomerConfig()">
                            <option value="">Kunde für Bearbeitung auswählen...</option>
                        </select>
                        <button class="btn btn-small" onclick="formatYAML()">🎨 Format</button>
                        <button class="btn btn-small" onclick="validateYAML()">✅ Validate</button>
                        <button class="btn btn-small btn-success" onclick="saveFromEditor()">💾 Speichern</button>
                        <button class="btn btn-small btn-warning" onclick="createBackup()">📦 Backup</button>
                    </div>
                </div>

                <div class="editor-tabs">
                    <button class="editor-tab active" onclick="switchEditorTab('yaml')">📄 YAML Editor</button>
                    <button class="editor-tab" onclick="switchEditorTab('preview')">👁️ Preview</button>
                    <button class="editor-tab" onclick="switchEditorTab('diff')">🔄 Diff</button>
                </div>

                <div class="editor-container">
                    <div class="editor-toolbar">
                        <div class="editor-toolbar-left">
                            <span class="editor-status" id="current-file">parameters.yml</span>
                            <button class="toolbar-btn" id="word-wrap-btn" onclick="toggleWordWrap()">📏 Wrap</button>
                            <button class="toolbar-btn" id="minimap-btn" onclick="toggleMinimap()">🗺️ Minimap</button>
                            <button class="toolbar-btn" id="theme-btn" onclick="toggleTheme()">🌙 Dark</button>
                        </div>
                        <div class="editor-toolbar-right">
                            <span class="editor-status" id="cursor-position">Zeile 1, Spalte 1</span>
                            <span class="editor-status" id="file-size">0 Zeichen</span>
                            <span class="editor-status" id="yaml-status">✅ Valid</span>
                        </div>
                    </div>
                    
                    <div id="monaco-editor"></div>
                    <div id="preview-container" class="preview-container"></div>
                    <div id="diff-container" class="diff-container"></div>
                </div>
            </div>

            <!-- Customer Management & Bulk Actions -->
            <div class="customers-section">
                <div class="customer-list">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">👥 Kunden-Verwaltung</h3>
                    <div id="customers-container">
                        <!-- Customers will be loaded here -->
                    </div>
                </div>

                <div class="bulk-actions">
                    <h3 style="margin-bottom: 15px; color: #856404;">🔄 Bulk-Aktionen</h3>
                    <div class="bulk-form">
                        <div>
                            <label for="custom-parameter">Parameter Name</label>
                            <input type="text" id="custom-parameter" placeholder="database_host">
                        </div>
                        <div>
                            <label for="bulk-value">Neuer Wert</label>
                            <input type="text" id="bulk-value" placeholder="localhost">
                        </div>
                        <div>
                            <span class="selected-count" id="selected-count">0 Kunden ausgewählt</span>
                        </div>
                        <div>
                            <button class="btn btn-warning" onclick="applyBulkUpdate()">
                                📝 Bulk Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let editor = null;
        let diffEditor = null;
        let currentCustomer = null;
        let originalContent = '';
        let isDarkTheme = true;
        let customers = [];

        // Initialize Monaco Editor
        require.config({ 
            paths: { 
                vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            }
        });

        require(['vs/editor/editor.main'], function () {
            initializeEditor();
            setupYAMLLanguage();
            loadSystemStatus();
        });

        function initializeEditor() {
            // Main YAML Editor
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: `# Symfony Parameters Configuration
# Bearbeiten Sie hier Ihre parameters.yml Datei
parameters:
    # Database Configuration
    database_host: localhost
    database_port: 3306
    database_name: symfony_app
    database_user: root
    database_password: ~

    # Mailer Configuration  
    mailer_transport: smtp
    mailer_host: localhost
    mailer_user: ~
    mailer_password: ~

    # Application Settings
    locale: de
    secret: ThisTokenIsNotSoSecretChangeIt
    
    # Custom Parameters
    app_name: "My Symfony App"
    app_version: "1.0.0"`,
                language: 'yaml',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                wordWrap: 'on',
                fontSize: 14,
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                scrollBeyondLastLine: false,
                folding: true,
                bracketMatching: 'always',
                autoIndent: 'full'
            });

            // Setup editor event listeners
            editor.onDidChangeCursorPosition((e) => {
                updateCursorPosition(e.position);
            });

            editor.onDidChangeModelContent(() => {
                updateFileSize();
                validateYAMLContent();
            });

            // Diff Editor for comparisons
            diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-container'), {
                theme: 'vs-dark',
                automaticLayout: true,
                readOnly: true
            });

            updateEditorStatus('Editor bereit');
        }

        function setupYAMLLanguage() {
            // Enhanced YAML syntax highlighting
            monaco.languages.setMonarchTokensProvider('yaml', {
                tokenizer: {
                    root: [
                        [/^(\s*)([\w\-_]+)(\s*)(:)/, ['', 'key.yaml', '', 'delimiter.yaml']],
                        [/^\s*-/, 'list.yaml'],
                        [/"([^"\\]|\\.)*"/, 'string.yaml'],
                        [/'([^'\\]|\\.)*'/, 'string.yaml'],
                        [/\b\d+\b/, 'number.yaml'],
                        [/\b(true|false|null|~)\b/, 'keyword.yaml'],
                        [/#.*$/, 'comment.yaml']
                    ]
                }
            });

            // Autocomplete for Symfony parameters
            monaco.languages.registerCompletionItemProvider('yaml', {
                provideCompletionItems: (model, position) => {
                    const suggestions = [
                        {
                            label: 'database_host',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'database_host: localhost',
                            documentation: 'Database server hostname'
                        },
                        {
                            label: 'database_port',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'database_port: 3306',
                            documentation: 'Database server port'
                        },
                        {
                            label: 'database_name',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'database_name: symfony_app',
                            documentation: 'Database name'
                        },
                        {
                            label: 'database_user',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'database_user: root',
                            documentation: 'Database username'
                        },
                        {
                            label: 'database_password',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'database_password: ~',
                            documentation: 'Database password'
                        },
                        {
                            label: 'mailer_transport',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'mailer_transport: smtp',
                            documentation: 'Mailer transport method'
                        },
                        {
                            label: 'mailer_host',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'mailer_host: localhost',
                            documentation: 'SMTP server hostname'
                        },
                        {
                            label: 'secret',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'secret: ThisTokenIsNotSoSecretChangeIt',
                            documentation: 'Application secret key'
                        },
                        {
                            label: 'locale',
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: 'locale: de',
                            documentation: 'Default application locale'
                        }
                    ];

                    return { suggestions };
                }
            });
        }

        // Editor Functions
        function switchEditorTab(tab) {
            // Update tab appearance
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide containers
            document.getElementById('monaco-editor').style.display = tab === 'yaml' ? 'block' : 'none';
            document.getElementById('preview-container').style.display = tab === 'preview' ? 'block' : 'none';
            document.getElementById('diff-container').style.display = tab === 'diff' ? 'block' : 'none';

            if (tab === 'preview') {
                updatePreview();
            } else if (tab === 'diff') {
                showDiff();
            }
        }

        function formatYAML() {
            try {
                const content = editor.getValue();
                const parsed = jsyaml.load(content);
                const formatted = jsyaml.dump(parsed, {
                    indent: 4,
                    lineWidth: 120,
                    noRefs: true
                });
                editor.setValue(formatted);
                showStatus('success', '✅ YAML erfolgreich formatiert!');
            } catch (error) {
                showStatus('error', `❌ Formatierung fehlgeschlagen: ${error.message}`);
            }
        }

        function validateYAML() {
            validateYAMLContent();
        }

        function validateYAMLContent() {
            try {
                const content = editor.getValue();
                jsyaml.load(content);
                document.getElementById('yaml-status').innerHTML = '✅ Valid';
                document.getElementById('yaml-status').style.color = '#28a745';
                return true;
            } catch (error) {
                document.getElementById('yaml-status').innerHTML = '❌ Invalid';
                document.getElementById('yaml-status').style.color = '#dc3545';
                
                // Show error markers in editor
                const model = editor.getModel();
                const markers = [{
                    severity: monaco.MarkerSeverity.Error,
                    startLineNumber: error.mark ? error.mark.line + 1 : 1,
                    startColumn: error.mark ? error.mark.column + 1 : 1,
                    endLineNumber: error.mark ? error.mark.line + 1 : 1,
                    endColumn: error.mark ? error.mark.column + 10 : 10,
                    message: error.message
                }];
                monaco.editor.setModelMarkers(model, 'yaml', markers);
                return false;
            }
        }

        function toggleWordWrap() {
            const currentWrap = editor.getOption(monaco.editor.EditorOption.wordWrap);
            const newWrap = currentWrap === 'on' ? 'off' : 'on';
            editor.updateOptions({ wordWrap: newWrap });
            
            const btn = document.getElementById('word-wrap-btn');
            btn.classList.toggle('active');
            btn.textContent = newWrap === 'on' ? '📏 Wrap On' : '📏 Wrap Off';
        }

        function toggleMinimap() {
            const currentMinimap = editor.getOption(monaco.editor.EditorOption.minimap);
            const newEnabled = !currentMinimap.enabled;
            editor.updateOptions({ minimap: { enabled: newEnabled } });
            
            const btn = document.getElementById('minimap-btn');
            btn.classList.toggle('active');
            btn.textContent = newEnabled ? '🗺️ Minimap On' : '🗺️ Minimap Off';
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const theme = isDarkTheme ? 'vs-dark' : 'vs';
            monaco.editor.setTheme(theme);
            
            if (diffEditor) {
                diffEditor.updateOptions({ theme: theme });
            }
            
            const btn = document.getElementById('theme-btn');
            btn.textContent = isDarkTheme ? '☀️ Light' : '🌙 Dark';
            
            // Update editor container background
            const container = document.querySelector('.editor-container');
            container.style.background = isDarkTheme ? '#1e1e1e' : '#ffffff';
        }

        function updatePreview() {
            try {
                const content = editor.getValue();
                const parsed = jsyaml.load(content);
                const previewHtml = generatePreviewHTML(parsed);
                document.getElementById('preview-container').innerHTML = previewHtml;
            } catch (error) {
                document.getElementById('preview-container').innerHTML = 
                    `<div style="color: red; padding: 20px;">
                        <h3>❌ YAML Parse Error</h3>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        function generatePreviewHTML(data, level = 0) {
            let html = '';
            const indent = '  '.repeat(level);
            
            if (typeof data === 'object' && data !== null) {
                for (const [key, value] of Object.entries(data)) {
                    if (typeof value === 'object' && value !== null) {
                        html += `${indent}<strong style="color: #2196F3;">${key}:</strong><br>`;
                        html += generatePreviewHTML(value, level + 1);
                    } else {
                        html += `${indent}<strong style="color: #4CAF50;">${key}:</strong> `;
                        html += `<span style="color: #FF9800;">${value}</span><br>`;
                    }
                }
            }
            
            return html;
        }

        function showDiff() {
            if (!originalContent) {
                document.getElementById('diff-container').innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: #666;">Keine Vergleichsdaten verfügbar</div>';
                return;
            }

            const originalModel = monaco.editor.createModel(originalContent, 'yaml');
            const modifiedModel = monaco.editor.createModel(editor.getValue(), 'yaml');
            
            diffEditor.setModel({
                original: originalModel,
                modified: modifiedModel
            });
        }

        function updateCursorPosition(position) {
            document.getElementById('cursor-position').textContent = 
                `Zeile ${position.lineNumber}, Spalte ${position.column}`;
        }

        function updateFileSize() {
            const content = editor.getValue();
            const size = content.length;
            const lines = content.split('\n').length;
            document.getElementById('file-size').textContent = 
                `${size} Zeichen, ${lines} Zeilen`;
        }

        function updateEditorStatus(message) {
            document.getElementById('editor-status').textContent = message;
        }

        // API Functions
        async function loadSystemStatus() {
            try {
                updateEditorStatus('Lade System-Status...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('total-customers').textContent = data.total_customers || 0;
                document.getElementById('connected-servers').textContent = data.connected_servers || 0;
                
                await loadCustomers();
                updateEditorStatus('System-Status geladen');
            } catch (error) {
                console.error('Error loading system status:', error);
                updateEditorStatus('Fehler beim Laden des Status');
                showStatus('error', 'Fehler beim Laden des System-Status');
            }
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                customers = await response.json();
                
                updateCustomerList();
                updateCustomerSelector();
            } catch (error) {
                console.error('Error loading customers:', error);
                showStatus('error', 'Fehler beim Laden der Kunden');
            }
        }

        function updateCustomerList() {
            const container = document.getElementById('customers-container');
            container.innerHTML = '';
            
            customers.forEach(customer => {
                const customerDiv = document.createElement('div');
                customerDiv.className = 'customer-item';
                customerDiv.innerHTML = `
                    <div class="customer-info">
                        <input type="checkbox" class="customer-checkbox" 
                               data-customer-id="${customer.server}:${customer.name}"
                               onchange="updateSelectedCount()">
                        <div>
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-server">${customer.server}</div>
                        </div>
                    </div>
                    <div class="customer-actions">
                        <button class="btn btn-small" onclick="loadCustomerInEditor('${customer.server}:${customer.name}')">
                            📝 Bearbeiten
                        </button>
                    </div>
                `;
                container.appendChild(customerDiv);
            });
        }

        function updateCustomerSelector() {
            const selector = document.getElementById('customer-selector');
            selector.innerHTML = '<option value="">Kunde für Bearbeitung auswählen...</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = `${customer.server}:${customer.name}`;
                option.textContent = `${customer.name} (${customer.server})`;
                selector.appendChild(option);
            });
        }

        async function loadCustomerConfig() {
            const selector = document.getElementById('customer-selector');
            const customerId = selector.value;
            
            if (!customerId) return;
            
            await loadCustomerInEditor(customerId);
        }

        async function loadCustomerInEditor(customerId) {
            try {
                updateEditorStatus(`Lade Konfiguration für ${customerId}...`);
                
                const response = await fetch(`/api/customers/${encodeURIComponent(customerId)}/parameters`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const content = await response.text();
                originalContent = content;
                editor.setValue(content);
                currentCustomer = customerId;
                
                document.getElementById('current-file').textContent = `${customerId}/parameters.yml`;
                document.getElementById('customer-selector').value = customerId;
                
                // Highlight customer in list
                document.querySelectorAll('.customer-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const customerItem = document.querySelector(`[data-customer-id="${customerId}"]`)?.closest('.customer-item');
                if (customerItem) {
                    customerItem.classList.add('active');
                }
                
                updateEditorStatus(`Konfiguration geladen: ${customerId}`);
                showStatus('success', `✅ Konfiguration für ${customerId} geladen`);
            } catch (error) {
                console.error('Error loading customer config:', error);
                updateEditorStatus('Fehler beim Laden');
                showStatus('error', `❌ Fehler beim Laden der Konfiguration: ${error.message}`);
            }
        }

        async function saveFromEditor() {
            if (!currentCustomer) {
                showStatus('error', '❌ Kein Kunde ausgewählt');
                return;
            }

            if (!validateYAMLContent()) {
                showStatus('error', '❌ YAML-Syntax ist ungültig. Bitte korrigieren Sie die Fehler.');
                return;
            }

            try {
                updateEditorStatus('Speichere Änderungen...');
                
                const content = editor.getValue();
                const response = await fetch(`/api/customers/${encodeURIComponent(currentCustomer)}/parameters`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: content
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                originalContent = content;
                
                updateEditorStatus('Änderungen gespeichert');
                showStatus('success', `✅ Parameter für ${currentCustomer} erfolgreich gespeichert!`);
            } catch (error) {
                console.error('Error saving config:', error);
                updateEditorStatus('Fehler beim Speichern');
                showStatus('error', `❌ Fehler beim Speichern: ${error.message}`);
            }
        }

        async function createBackup() {
            if (!currentCustomer) {
                showStatus('error', '❌ Kein Kunde ausgewählt');
                return;
            }

            try {
                updateEditorStatus('Erstelle Backup...');
                
                const response = await fetch(`/api/customers/${encodeURIComponent(currentCustomer)}/backup`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                updateEditorStatus('Backup erstellt');
                showStatus('success', `✅ Backup für ${currentCustomer} erstellt: ${result.backup_file}`);
            } catch (error) {
                console.error('Error creating backup:', error);
                updateEditorStatus('Fehler beim Backup');
                showStatus('error', `❌ Fehler beim Erstellen des Backups: ${error.message}`);
            }
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('selected-customers').textContent = count;
            document.getElementById('selected-count').textContent = `${count} Kunden ausgewählt`;
        }

        async function applyBulkUpdate() {
            const paramName = document.getElementById('custom-parameter').value.trim();
            const paramValue = document.getElementById('bulk-value').value.trim();
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            
            if (!paramName || !paramValue) {
                showStatus('error', '❌ Bitte Parameter-Name und Wert eingeben');
                return;
            }
            
            if (checkboxes.length === 0) {
                showStatus('error', '❌ Bitte mindestens einen Kunden auswählen');
                return;
            }
            
            const customerIds = Array.from(checkboxes).map(cb => cb.dataset.customerId);
            
            try {
                updateEditorStatus('Führe Bulk-Update durch...');
                
                const response = await fetch('/api/bulk-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customers: customerIds,
                        parameter: paramName,
                        value: paramValue
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                updateEditorStatus('Bulk-Update abgeschlossen');
                showStatus('success', `✅ Bulk-Update für ${customerIds.length} Kunden erfolgreich!`);
                
                // Reload current customer if affected
                if (currentCustomer && customerIds.includes(currentCustomer)) {
                    await loadCustomerInEditor(currentCustomer);
                }
            } catch (error) {
                console.error('Error applying bulk update:', error);
                updateEditorStatus('Fehler beim Bulk-Update');
                showStatus('error', `❌ Fehler beim Bulk-Update: ${error.message}`);
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveFromEditor();
                        break;
                    case 'f':
                        e.preventDefault();
                        formatYAML();
                        break;
                    case 'b':
                        e.preventDefault();
                        createBackup();
                        break;
                }
            }
        });
    </script>
</body>
</html> 